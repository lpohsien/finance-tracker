# Gemini 3 Prompt for Finance Tracker Telegram Bot
<role>
You are an expert Python developer and solution architect specializing in building scalable, secure, and maintainable Telegram bots. You are proficient in `python-telegram-bot`, data parsing, and Google Cloud Platform (GCP) deployment. You prioritize clean, modular code and comprehensive documentation.
</role>

<context>
I am building a personal finance tracking system. I need a Telegram bot that acts as an interface for ingesting transaction data from bank notifications and providing spending analysis. The bot will receive text messages generated by an Apple Shortcut. The Shortcut concatenates the raw bank SMS, the current ISO timestamp, and user remarks into a single string separated by a custom delimiter (e.g., || or ,). The bot must parse this composite string, not a raw Telegram forwarded_message object.
</context>

<task>
Design and implement a Telegram bot with the following capabilities:

1.  **Message Ingestion & Parsing**:
    *   Monitor incoming messages.
    *   Parse specific UOB transaction message formats (PayNow Incoming, PayNow Outgoing, Card Transactions).
    *   Ignore non-transaction messages.
    *   Extract: Transaction Type, Amount (signed), Card/Account last 4 digits, Date/Time (ISO 8601), Merchant/Recipient, Remarks.
    *   **Smart Categorization**: Implement a logic to categorize transactions based on keywords in the message/remarks. (e.g., "Dinner" -> Food, "Train" -> Transport). Also implement a LLM-based categorization fallback for uncategorized transactions (making use of the GCP/google.gemini ecosystem), passing the whole message and remarks for context and obtain the category (among the predefined categories).

2.  **Data Persistence**:
    *   Save extracted transactions to a local CSV file.
    *   Ensure the storage mechanism is robust and can be easily migrated to a database in the future.
    *   Ensure data persistence across bot restarts, especially when deployed on GCP (consider using a persistent volume or external storage if necessary for the free tier, or simply a file for the MVP).

3.  **Analytics & Reporting**:
    *   Implement commands to generate statistics:
        *   Total income/expense for a period.
        *   Category breakdown.
        *   Average daily spending.
        *   "Big ticket" expense listing (configurable threshold).
    *   Support setting monthly budgets and category limits.
    *   Implement alert logic for budget thresholds (50%, 75%, 90%, 100%).

4.  **Security**:
    *   Implement user whitelisting to ensure only authorized users (me) can interact with the bot and access data.

5.  **Deployment**:
    *   Provide a complete guide and configuration for deploying this bot on Google Cloud Platform (GCP) Free Tier.
    *   Include a `Dockerfile` or setup script.
    *   Deploy specifically on a GCP Compute Engine e2-micro instance. Do not use Cloud Run/Functions as this is a stateful polling bot. Include a systemd service file (bot.service) to ensure the bot auto-restarts on VM reboot.
</task>

<input_data_examples>
The bot must correctly parse these message formats:

**Type 1: PayNow Outgoing**
`You made a PayNow transfer of SGD 19.36 to PAYNOW - SUPPORTED B (UEN ending C002) on your a/c ending XXXX at 1:44PM SGT, 27 Dec 25. If unauthorised, call UOB 24/7 Fraud Hotline.,2025-12-28T15:57:31+08:00, __REMARKS__`
Note: Since the transaction timestamp is also included in the bank message, the bot should prioritize that (i.e. the 1:44PM SGT, 27 Dec 25 part) over the ISO timestamp provided at the end. But the bank message timestamp should still be converted to ISO 8601 format for storage.

**Type 2: PayNow Incoming**
`You have received SGD 18.62 in your PayNow-linked account ending XXXX on 07-MAY-2025 01:42AM.,2025-12-28T15:57:31+08:00, __REMARKS__`
Note: Use the timestamp in the bank message (07-MAY-2025 01:42AM) for storage, converted to ISO 8601 format.

**Type 3: Card Transaction**
`A transaction of SGD 15.00 was made with your UOB Card ending XXXX on 26/12/25 at JINJJA CHICKEN @ JEWEL. If unauthorised, call 24/7 Fraud Hotline now,2025-12-28T15:57:31+08:00, __REMARKS__`
Note: No timestamp is provided in the bank message (only the date), so use the ISO timestamp at the end for storage.

**Type 4: Ignore**
`Weâ€™ve enhanced your UOB One Debit Card! ...`
</input_data_examples>

<constraints>
*   **Language**: Python 3.13+
*   **Library**: `python-telegram-bot` (latest stable version)
*   **Style**: Modular, PEP 8 compliant, type-hinted.
*   **Architecture**: Decouple the analysis logic from the bot logic so analysis can be run independently on the CSV file.
*   **Storage**: Use CSV for MVP; design for easy migration to a database.
*   **Deployment**: Compatible with local development (without docker) and production on GCP Free Tier.
*   **Deployment Target**: Google Cloud Compute Engine (e2-micro) only. Provide a `systemd` service file content for process management.
*   **Project management**: Uses `uv` for dependency management.
*   **Documentation**: Comprehensive inline comments and a README.md for setup and deployment instructions.
*   **Testing**: STRICT REQUIREMENT. Provide a `tests/` directory with `pytest` files covering:
        1.  Regex extraction for ALL input examples (Type 1-3).
        2.  Analytics function logic (budget checks, totals).
*   **Interaction Model**: Use stateless commands for configuration (e.g., `/set_budget 5000`, `/add_category Food`) rather than conversation handlers to reduce complexity.
*   **Input Handling**: Treat inputs as user-sent text messages formatted by Apple Shortcuts, NOT raw forwarded objects. Expect format: `"{Bank_Msg},{ISO_Timestamp},{Remarks}"`.
*   **Date Parsing**: The parser must be resilient to multiple date formats found in UOB SMS (DD MMM YY, DD-MMM-YYYY, DD/MM/YY). Use the library dateutil or arrow for robust parsing if standard datetime is too rigid.
</constraints>

<output_format>
Please provide:
1.  **Project Structure**: A file tree of the proposed solution.
2.  **Source Code**: Complete code for `main.py`, `bot_interface.py`, `parser.py`, `storage.py`, `analytics.py`, `config.py`, and `Dockerfile`.
3.  **Requirements**: `requirements.txt` or `pyproject.toml`.
4.  **Deployment Guide**: Step-by-step instructions for GCP deployment.
5.  **Tests**: A `tests/` folder containing `test_parser.py` and `test_analytics.py`.
</output_format>

<final_instruction>
Think step-by-step. First, analyze the message formats to design a robust regex parsing strategy. Then, design the data structure. Finally, implement the bot handlers and deployment configuration. Clearly document each part of the code and the deployment steps.
</final_instruction>
